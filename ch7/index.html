
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ch6/">
      
      
        <link rel="next" href="../ch8/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>Network - Understand Container</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#network" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Understand Container" class="md-header__button md-logo" aria-label="Understand Container" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Understand Container
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Network
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/binchenX/understand_container" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Understand Container" class="md-nav__button md-logo" aria-label="Understand Container" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Understand Container
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/binchenX/understand_container" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OCI Specification
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Namespaces
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cgroups
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capabilities
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Filesystems
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Root & Users
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Network
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Network
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-bridge-network-using-netns" class="md-nav__link">
    <span class="md-ellipsis">
      Setup bridge network using netns
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bridge-veth-route-and-iptablenat" class="md-nav__link">
    <span class="md-ellipsis">
      Bridge, Veth, Route, and iptable/NAT
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bridge, Veth, Route, and iptable/NAT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#route-table" class="md-nav__link">
    <span class="md-ellipsis">
      Route Table
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptablenat" class="md-nav__link">
    <span class="md-ellipsis">
      Iptable/NAT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#port-forwarddnat" class="md-nav__link">
    <span class="md-ellipsis">
      Port forward/DNAT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#share-network-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      Share network namespace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CNI
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup-bridge-network-using-netns" class="md-nav__link">
    <span class="md-ellipsis">
      Setup bridge network using netns
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bridge-veth-route-and-iptablenat" class="md-nav__link">
    <span class="md-ellipsis">
      Bridge, Veth, Route, and iptable/NAT
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bridge, Veth, Route, and iptable/NAT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#route-table" class="md-nav__link">
    <span class="md-ellipsis">
      Route Table
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptablenat" class="md-nav__link">
    <span class="md-ellipsis">
      Iptable/NAT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#port-forwarddnat" class="md-nav__link">
    <span class="md-ellipsis">
      Port forward/DNAT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#share-network-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      Share network namespace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="network">Network</h1>
<p>When it comes to container networking, the OCI runtime spec does nothing more than creating or joining a <a href="http://man7.org/linux/man-pages/man7/network_namespaces.7.html">network namespace</a>. All other tasks are left to be handled using <a href="https://github.com/opencontainers/runtime-spec/blob/master/config.md#posix-platform-hooks">hooks</a>, which allow you to inject into different <a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#lifecycle">stages</a> of the container runtime and perform some customization.</p>
<p>With the default <code>config.json</code>, you will only see a <code>loop device</code>, not an <code>eth0</code> that you normally see on the host, which allows you to communicate with the outside world. However, we can set up a simple bridge network using <code>netns</code> as the hook.</p>
<p>Download <a href="https://github.com/genuinetools/netns">netns</a> and copy the binary to <code>/usr/local/bin</code>, as assumed by the following <code>config.json</code>. It's worth noting that the hooks are executed in the runtime namespace, not the container namespace. This means, among other things, that the hooks binary should reside on the host system, not in the container. Therefore, you don't need to put <code>netns</code> into the container rootfs.</p>
<h2 id="setup-bridge-network-using-netns">Setup bridge network using netns</h2>
<p>Make the following changes to <code>config.json</code>. In addition to the hooks, we also need the <code>CAP_NET_RAW</code> capability so that we can use <code>ping</code> inside the container for basic network checks.</p>
<pre><code>binchen@m:~/container/runc$ git diff
diff --git a/config.json b/config.json
index 25a3154..d1c0fb2 100644
--- a/config.json
+++ b/config.json
@@ -18,12 +18,16 @@
                        &quot;bounding&quot;: [
                                &quot;CAP_AUDIT_WRITE&quot;,
                                &quot;CAP_KILL&quot;,
-                               &quot;CAP_NET_BIND_SERVICE&quot;
+                               &quot;CAP_NET_BIND_SERVICE&quot;,
+                               &quot;CAP_NET_RAW&quot;
                        ],
                        &quot;effective&quot;: [
                                &quot;CAP_AUDIT_WRITE&quot;,
                                &quot;CAP_KILL&quot;,
-                               &quot;CAP_NET_BIND_SERVICE&quot;
+                               &quot;CAP_NET_BIND_SERVICE&quot;,
+                               &quot;CAP_NET_RAW&quot;
                        ],
                        &quot;inheritable&quot;: [
                                &quot;CAP_AUDIT_WRITE&quot;,
@@ -33,7 +37,9 @@
                        &quot;permitted&quot;: [
                                &quot;CAP_AUDIT_WRITE&quot;,
                                &quot;CAP_KILL&quot;,
-                               &quot;CAP_NET_BIND_SERVICE&quot;
+                               &quot;CAP_NET_BIND_SERVICE&quot;,
+                               &quot;CAP_NET_RAW&quot;
                        ],
                        &quot;ambient&quot;: [
                                &quot;CAP_AUDIT_WRITE&quot;,
@@ -131,6 +137,16 @@
                        ]
                }
        ],
+
+       &quot;hooks&quot;:
+               {
+                       &quot;prestart&quot;: [
+                               {
+                                       &quot;path&quot;: &quot;/usr/local/bin/netns&quot;
+                               }
+                       ]
+               },
+
        &quot;linux&quot;: {
                &quot;resources&quot;: {
                        &quot;devices&quot;: [
</code></pre>
<p>start a container with this new config.</p>
<p>Inside the container, we find an <code>eth0</code> device, in addition to a <code>loop</code> device that is always there.</p>
<pre><code>/ # ifconfig
eth0      Link encap:Ethernet  HWaddr 8E:F3:5C:D8:CA:2B
          inet addr:172.19.0.2  Bcast:172.19.255.255  Mask:255.255.0.0
          inet6 addr: fe80::8cf3:5cff:fed8:ca2b/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:21992 errors:0 dropped:0 overruns:0 frame:0
          TX packets:241 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:2610155 (2.4 MiB)  TX bytes:22406 (21.8 KiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:6 errors:0 dropped:0 overruns:0 frame:0
          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:498 (498.0 B)  TX bytes:498 (498.0 B)
</code></pre>
<p>And, you will be able to ping (*) outside world.</p>
<pre><code>/ # ping 216.58.199.68
PING 216.58.199.68 (216.58.199.68): 56 data bytes
64 bytes from 216.58.199.68: seq=0 ttl=55 time=18.382 ms
64 bytes from 216.58.199.68: seq=1 ttl=55 time=17.936 ms
</code></pre>
<p>Notes: 216.58.199.68 is one IP of google.com. If we had set up the DNS namesever (e.g echo nameserver 8.8.8.8 &gt; /etc/resolv.conf), we would have been able to ping www.google.com.</p>
<p>So, how it works?</p>
<h2 id="bridge-veth-route-and-iptablenat">Bridge, Veth, Route, and iptable/NAT</h2>
<p>When a hook is called, the container runtime passes the container's <a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#state">state</a> to the hook. This includes the PID of the container (in the runtime namespace). The hook, <code>Netns</code> in this case, uses this PID to determine the network namespace in which the container is supposed to run. With this PID, <code>netns</code> performs a few tasks:</p>
<p>1) It creates a Linux <a href="https://wiki.archlinux.org/index.php/Network_bridge">bridge</a> with the default name <code>netns0</code> (if one doesn't already exist). It also sets up the MASQUERADE rule on the host.
2) It creates a <a href="http://man7.org/linux/man-pages/man4/veth.4.html">veth pair</a>, connects one endpoint of the pair to the bridge <code>netns0</code>, and places the other one (renamed to <code>eth0</code>) into the container's network namespaces.
3) It allocates and assigns an IP to the container interface (<code>eth0</code>) and sets up the Route table for the container.</p>
<p>We'll soon delve into the details of the above-mentioned tasks. But first, let's start another container with the same <code>config.json</code>. This should make things clearer and more interesting than having just one container.</p>
<ul>
<li>bridge and interfaces</li>
</ul>
<p>A bridge <code>netns0</code> is created and two interfaces are associated with it. The name of the interface follows the format of
<code>netnsv0-$(containerPid)</code>.</p>
<pre><code>$ brctl show netns0
bridge name    bridge id        STP enabled    interfaces
netns0        8000.f2df1fb10980    no        netnsv0-8179
                                             netnsv0-10577
</code></pre>
<p>As we explained before <code>netnsv0-8179</code> is one endpoint of the veth pair, connecting to the bridge; the other endpoint is inside of the container 8179. Let's find it out.</p>
<ul>
<li>veth pair</li>
</ul>
<p>On the host, we can see the peer of <code>netnsv0-8179</code> is index <code>7</code></p>
<pre><code>$ ethtool -S netnsv0-8179
NIC statistics:
     peer_ifindex: 7
</code></pre>
<p>And in the container 8179, we can see the eth0's index is 7. It confirms that the <code>eth0</code> in container 8179 is paired with <code>netnsv0-8179</code> in the host. Same is true for <code>netnsv0-10577</code> and the <code>eth0</code> in container 10577.</p>
<pre><code>/ # ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue qlen 1000
    link/ether 8e:f3:5c:d8:ca:2b brd ff:ff:ff:ff:ff:ff
    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::8cf3:5cff:fed8:ca2b/64 scope link
       valid_lft forever preferred_lft forever
</code></pre>
<p>So far, we have seen how a container is connected to host virtul bridge using veth pair. We have the network interfaces but still need a few more setups: Route table and iptable.</p>
<h3 id="route-table">Route Table</h3>
<p>Here is the route table for In container <code>8179</code>:</p>
<pre><code>/ # route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         172.19.0.1      0.0.0.0         UG    0      0        0 eth0
172.19.0.0      *               255.255.0.0     U     0      0        0 eth0
</code></pre>
<p>We can see the all traffic will goes through <code>eth0</code> to the gateway, which is the bridge <code>netns0</code>, as shown by:</p>
<pre><code># in container
/ # ip route get 216.58.199.68 from 172.19.0.2
216.58.199.68 from 172.19.0.2 via 172.19.0.1 dev eth0
</code></pre>
<p>In the host:</p>
<pre><code>$ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192-168-1-1     0.0.0.0         UG    0      0        0 wlan0
172.19.0.0      *               255.255.0.0     U     0      0        0 netns0
192.168.1.0     *               255.255.255.0   U     9      0        0 wlan0
192.168.122.0   *               255.255.255.0   U     0      0        0 virbr0
</code></pre>
<p>Also:</p>
<pre><code># on host
$ ip route get 216.58.199.68 from 172.19.0.1
216.58.199.68 from 172.19.0.1 via 192.168.1.1 dev wlan0
    cache
</code></pre>
<p>The <code>192.168.1.1</code> is the ip of my home route, which is a <em>real</em> bridge.</p>
<p>Piece together the route in the container, we can see when ping google from the container, the package will go to the virtual bridge created by the <code>netns</code> first, and then goes to the real route gateway at my home, and then into the wild internet and finally to one of the goole servers.</p>
<h2 id="iptablenat">Iptable/NAT</h2>
<p>Another change made by the <code>netns</code> is to set up the MASQUERADE target, that means all traffic with a source of <code>172.19.0.0/16</code> will be MASQUERADE or NAT-ed with the host address so that outside can only see the host (ip) but not the container (ip).</p>
<pre><code># sudo iptables -t nat --list
Chain POSTROUTING (policy ACCEPT)
target     prot  opt source               destination
MASQUERADE  all  --  172.19.0.0/16        anywhere
</code></pre>
<h2 id="port-forwarddnat">Port forward/DNAT</h2>
<p>With Ip MASQUERADE, the traffic can goes out from the container to the internet as well as the return traffic from the same connection. However, for conatiner to accept incoming connections, you have set up the port forwarding using iptable DNAT target.</p>
<p>In container:</p>
<pre><code>/ # nc -p 10001 -l
</code></pre>
<p>port map: host:100088 maps to container xyxy12:1024</p>
<pre><code>iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 100088 -j DNAT --to-destination 172.19.0.8:10001
</code></pre>
<p>host</p>
<pre><code>echo the host says HI |  nc localhost 5555
</code></pre>
<h2 id="share-network-namespace">Share network namespace</h2>
<p>To join the network namespace of another container, set up the network namespace path pointing to the one you want to join. In our example, we'll join the network namespace of container 8179.</p>
<pre><code>{
-                &quot;type&quot;: &quot;network&quot;
+                &quot;type&quot;: &quot;network&quot;,
+                &quot;path&quot;: &quot;/proc/8179/ns/net&quot;
</code></pre>
<p>Remember to remove the prestart hook, since we don't need to create a new network interface (veth pair and route table) this time.</p>
<p>Start a new container, and we'll find that the new container has the same <code>eth0</code> device (as well as same ip) with the container 8179 and the route table is same as the one in container 8179 since they are in the same network namespace.</p>
<pre><code>/ # ifconfig
eth0      Link encap:Ethernet  HWaddr 8E:F3:5C:D8:CA:2B
          inet addr:172.19.0.2  Bcast:172.19.255.255  Mask:255.255.0.0
          inet6 addr: fe80::8cf3:5cff:fed8:ca2b/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:22371 errors:0 dropped:0 overruns:0 frame:0
          TX packets:241 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:2658017 (2.5 MiB)  TX bytes:22406 (21.8 KiB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:6 errors:0 dropped:0 overruns:0 frame:0
          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:498 (498.0 B)  TX bytes:498 (498.0 B)
</code></pre>
<p>So, despite being in different containers, they share the same network device, route table, port numbers and all the other network resources. For example, if you start a web service in container 8179 port 8100 and you will be able to access the service in this new container using localhost:8100.</p>
<h2 id="summary">Summary</h2>
<p>We've seen how to use <code>netns</code> as a hook to set up a bridge network for our containers, enabling them to communicate with the internet and each other. In diagram form, we've set up something like this:</p>
<pre><code>+---------------------------------------------------------+
|                                                         |
|                                                         |
|                                      +----------------+ |
|                                      |   wlan/eth0    +---+
|                                      |                | |
|                                      +---------+------+ |
|                                                |        |
|                                          +-----+----+   |
|                                    +-----+route     |   |
|                                    |     |table     |   |
|                                    |     +----------+   |
|    +-------------------------------+----------+         |
|    |                                          |         |
|    |                bridge:netns0             |         |
|    |                                          |         |
|    +-----+-----------------------+------------+         |
|          | interface             | interface            |
|    +-----+-----+          +------+----+                 |
|    |           |          |10:netnsv0 |                 |
|    |8:netnsv0- |          +-10577@if9 |                 |
|    |8179@if7   |          |           |                 |
|    +---+-------+          +----+------+                 |
|        |                       |                        |
|        |                       |                        |
| +-----------------+     +-----------------+             |
| |      |          |     |      |          |             |
| |  +---+------+   |     | +----+------+   |             |
| |  |          |   |     | |           |   |             |
| |  |7:eth0@if8|   |     | | 9:eth0@if10   |             |
| |  |          |   |     | |           |   |             |
| |  |          |   |     | |           |   |             |
| |  +----------+   |     | +-----------+   |             |
| |                 |     |                 |             |
| |  c8179          |     |  c10577         |             |
| +-----------------+     +-----------------+             |
|                                                         |
+---------------------------------------------------------+
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../assets/inject-link.js"></script>
      
    
  </body>
</html>
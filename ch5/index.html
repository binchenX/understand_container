
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ch4/">
      
      
        <link rel="next" href="../ch6/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>Filesystems - Understand Container</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mount-namespace-pivot_root" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Understand Container" class="md-header__button md-logo" aria-label="Understand Container" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Understand Container
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Filesystems
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/binchenX/understand_container" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Understand Container" class="md-nav__button md-logo" aria-label="Understand Container" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Understand Container
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/binchenX/understand_container" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OCI Specification
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Namespaces
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cgroups
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capabilities
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Filesystems
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Filesystems
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mount-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      Mount Namespace
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mount Namespace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mnt-namespace-for-container" class="md-nav__link">
    <span class="md-ellipsis">
      Mnt Namespace for Container
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot_root" class="md-nav__link">
    <span class="md-ellipsis">
      pivot_root
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chroot" class="md-nav__link">
    <span class="md-ellipsis">
      chroot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bind-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Bind Mount
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-access-host-usb" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise: Access Host USB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-permission-change-after-mount" class="md-nav__link">
    <span class="md-ellipsis">
      User Permission Change After Mount
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-volume" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Volume
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Root & Users
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ch8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CNI
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mount-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      Mount Namespace
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mount Namespace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mnt-namespace-for-container" class="md-nav__link">
    <span class="md-ellipsis">
      Mnt Namespace for Container
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot_root" class="md-nav__link">
    <span class="md-ellipsis">
      pivot_root
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chroot" class="md-nav__link">
    <span class="md-ellipsis">
      chroot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bind-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Bind Mount
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-access-host-usb" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise: Access Host USB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-permission-change-after-mount" class="md-nav__link">
    <span class="md-ellipsis">
      User Permission Change After Mount
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-volume" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Volume
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="mount-namespace-pivot_root">Mount namespace &amp; pivot_root</h1>
<p>Files in a Linux system are organized as a tree. The tree normally starts with a root file system (called <code>rootfs</code>) provided by the Linux distribution, and the rootfs is mounted as "/". Later, additional file systems can optionally be attached to a subdirectory, such as /data, which could point to an disk.</p>
<p><code>mount(2)</code> is the system call used to attach a file system or a directory to a node of the root tree. When the system boots up, the init process performs multiple mount calls to set up the file system properly, creating the initial mount table. All processes have their own mount table, but they normally point to the same one - the one set up by the init process. However, a process can also have a separate mount table from its parent. It starts with a copy of the parent's table, but any subsequent changes to it (incurred by <code>mount</code>) will only impact itself. This is what the <code>mount namespace</code> is for. It's worth noting that in the same mount namespace, any changes to the mount table by one process will be visible to another process. Because of this, when you mount a USB disk on the shell, the file explorer will be able to see the content as well.</p>
<h2 id="mount-namespace">Mount Namespace</h2>
<p>Normally, an application won't create a separate mount namespace when it starts.</p>
<p>For example, there are two mount namespaces on my host:</p>
<pre><code>$ sudo cinf | grep mn
 4026531857  mnt  1  0
 4026531840  mnt  311 0,1,7,101,102,106,107,109,111,113,116,121,125,126,127,1000,65534  /sbin/init
</code></pre>
<p>But the first one has only one process kdevtmpfs, which is a kernel process.</p>
<pre><code>$ sudo cinf --namespace 4026531857

 PID  PPID  NAME       CMD  NTHREADS  CGROUPS             STATE
 46   2     kdevtmpfs       1         xxx  S (sleeping)

$ ps -ef | grep kdevtmpfs
root        46     2  0 10:17 ?        00:00:00 [kdevtmpfs]
</code></pre>
<p>All the other processes are in the second mount namespace created by <code>/sbin/init</code>. If you check the mount points of two processes in that mount namespace (by using <code>cat /proc/pid/mounts</code>), they are all the same.</p>
<h3 id="mnt-namespace-for-container">Mnt Namespace for Container</h3>
<p>Let's start a container and see what changes in the mount namespaces.</p>
<pre><code>sudo runc run xyxy12
</code></pre>
<p>Check the mount namespace</p>
<pre><code>$ sudo cinf | grep mnt
 4026531840  mnt 333 0,1,7,101,102,106,107,109,111,113,116,121,125,126,127,1000,65534  /sbin/init
 4026532458  mnt 1   0         sh
 4026531857  mnt 1   0
</code></pre>
<p>We have a <strong>new</strong> mount namespace, 4026532458, which is created when run container xyxy12:</p>
<pre><code>$ sudo cinf -namespace 4026532458
 PID    PPID   NAME  CMD  NTHREADS  CGROUPS                                            STATE
 11674  11665  sh    sh   1         14:name=dsystemd:/                                 S (sleeping)

$ sudo runc ps xyxy12
UID        PID  PPID  C STIME TTY          TIME CMD
root     11674 11665  0 12:00 pts/0    00:00:00 sh
</code></pre>
<p>And here is the dump of the mount info for our new container.</p>
<pre><code>$ cat /proc/11674/mounts | sort | uniq
cgroup /sys/fs/cgroup/blkio cgroup ro,nosuid,nodev,noexec,relatime,blkio 0 0
cgroup /sys/fs/cgroup/cpuacct cgroup ro,nosuid,nodev,noexec,relatime,cpuacct 0 0
cgroup /sys/fs/cgroup/cpu cgroup ro,nosuid,nodev,noexec,relatime,cpu 0 0
cgroup /sys/fs/cgroup/cpuset cgroup ro,nosuid,nodev,noexec,relatime,cpuset 0 0
cgroup /sys/fs/cgroup/devices cgroup ro,nosuid,nodev,noexec,relatime,devices 0 0
cgroup /sys/fs/cgroup/dsystemd cgroup ro,nosuid,nodev,noexec,relatime,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=dsystemd 0 0
cgroup /sys/fs/cgroup/freezer cgroup ro,nosuid,nodev,noexec,relatime,freezer 0 0
cgroup /sys/fs/cgroup/hugetlb cgroup ro,nosuid,nodev,noexec,relatime,hugetlb 0 0
cgroup /sys/fs/cgroup/memory cgroup ro,nosuid,nodev,noexec,relatime,memory 0 0
cgroup /sys/fs/cgroup/net_cls cgroup ro,nosuid,nodev,noexec,relatime,net_cls 0 0
cgroup /sys/fs/cgroup/net_prio cgroup ro,nosuid,nodev,noexec,relatime,net_prio 0 0
cgroup /sys/fs/cgroup/perf_event cgroup ro,nosuid,nodev,noexec,relatime,perf_event 0 0
cgroup /sys/fs/cgroup/pids cgroup ro,nosuid,nodev,noexec,relatime,pids 0 0
/dev/disk/by-uuid/22cb3888-325e-4283-a605-d2f60d11bb96 / ext4 ro,relatime,errors=remount-ro,data=ordered 0 0
/home/binchen/container/runc/devpts /dev/console devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=666 0 0
/home/binchen/container/runc/devpts /dev/pts devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=666 0 0
/home/binchen/container/runc/mqueue /dev/mqueue mqueue rw,nosuid,nodev,noexec,relatime 0 0
/home/binchen/container/runc/proc /proc/asound proc ro,relatime 0 0
/home/binchen/container/runc/proc /proc/bus proc ro,relatime 0 0
/home/binchen/container/runc/proc /proc/fs proc ro,relatime 0 0
/home/binchen/container/runc/proc /proc/irq proc ro,relatime 0 0
/home/binchen/container/runc/proc /proc proc rw,relatime 0 0
/home/binchen/container/runc/proc /proc/sys proc ro,relatime 0 0
/home/binchen/container/runc/proc /proc/sysrq-trigger proc ro,relatime 0 0
/home/binchen/container/runc/shm /dev/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k 0 0
/home/binchen/container/runc/sysfs /sys sysfs ro,nosuid,nodev,noexec,relatime 0 0
/home/binchen/container/runc/tmpfs /dev tmpfs rw,nosuid,size=65536k,mode=755 0 0
/home/binchen/container/runc/tmpfs /proc/kcore tmpfs rw,nosuid,size=65536k,mode=755 0 0
/home/binchen/container/runc/tmpfs /proc/sched_debug tmpfs rw,nosuid,size=65536k,mode=755 0 0
/home/binchen/container/runc/tmpfs /proc/timer_list tmpfs rw,nosuid,size=65536k,mode=755 0 0
/home/binchen/container/runc/tmpfs /proc/timer_stats tmpfs rw,nosuid,size=65536k,mode=755 0 0
name=systemd /sys/fs/cgroup/systemd cgroup ro,nosuid,nodev,noexec,relatime,name=systemd 0 0
tmpfs /proc/scsi tmpfs ro,relatime 0 0
tmpfs /sys/firmware tmpfs ro,relatime 0 0
tmpfs /sys/fs/cgroup tmpfs ro,nosuid,nodev,noexec,relatime,mode=755 0 0
</code></pre>
<p>The content might not be of much interest to you. We will skip the details of most of these entries, except for one:</p>
<pre><code>/dev/disk/by-uuid/22cb3888-325e-4283-a605-d2f60d11bb96 / ext4 ro,relatime,errors=remount-ro,data=ordered 0 0
</code></pre>
<p>This mount src is pointing to the <code>/dev/sda2</code>, which is our host's rootfs mounting to.</p>
<pre><code>$ ll /dev/disk/by-uuid/22cb3888-325e-4283-a605-d2f60d11bb96
lrwxrwxrwx 1 root root 10 Apr 28 13:28 /dev/disk/by-uuid/22cb3888-325e-4283-a605-d2f60d11bb96 -&gt; ../../sda2

$ mount
/dev/sda2 on / type ext4 (rw,errors=remount-ro)
</code></pre>
<p>Does that sound surprising and alarming to you? Why is the root of the container is same as the root of the host? So with a new mount namespace, we still can access the root of the host? Shouldn't the container be "jailed" in the rootfs the contained is started in?</p>
<p>Let's check one more thing, compare the inode number of the <code>/</code> in the container and the inode of the container's rootfs.</p>
<pre><code># in container
/ # ls -di /
25846165 /
</code></pre>
<pre><code># on host
$ ls -di ~/container/runc/rootfs/
25846165 /home/binchen/container/runc/rootfs/
</code></pre>
<p>They are same! That means the root of the container is the rootfs, or directory of its runtime bundle, in OCI's term, as you expected!</p>
<p>So, why? From the mount we see "/" is mounted to /dev/sda2, which is same as the root of the host but in fact, the root is the container bundle directory?</p>
<p>Entering <code>pivot_root</code>.</p>
<h2 id="pivot_root">pivot_root</h2>
<p>The "jail" is done by <a href="http://man7.org/linux/man-pages/man2/pivot_root.2.html">pivot_root</a>, which changes the root of the process to the runtime bundle directory.</p>
<p><a href="https://github.com/opencontainers/runc/blob/master/libcontainer/rootfs_linux.go#L647">This</a> is the code did that magic. The latest version looks less easy to understand than the earlier version since it used an idea from <a href="https://github.com/lxc/lxc/blob/master/src/lxc/conf.c#L1092">lxc</a> making privot_root working on read-only rootfs, so there is no need to create a temporary writable directory.</p>
<h2 id="chroot">chroot</h2>
<p>It won't be complete if we wouldn't mention <code>chroot(2)</code> when talking about the filesystem for the container. However, it is not mandatory to create a new mnt namespace and use privot_root. Optionally, but less ideally, you can use <code>chroot(2)</code>, which will "jail" the calling process (and all its children) into the rootfs the container starts with. </p>
<p>Unlike the mount namespace, <code>chroot</code> won't change anything to mount, it just changes the process path lookup, interpreting the <code>/</code> as the path chroot-ed to; for the difference between <code>chroot</code> and <code>privot_root</code> see <a href="https://lists.linuxcontainers.org/pipermail/lxc-devel/2011-September/002065.html">here</a>. In short, privot_root is more thorough, and safer.</p>
<p>To use chroot, if you like, make following changes to your default config.json. In addition to removal of  <code>type:mount</code>, we have removed "maskedPaths" and "readonlyPaths" which will require a private mount namespace to work.</p>
<pre><code>diff --git a/config.json b/config.json
index 25a3154..9382207 100644
--- a/config.json
+++ b/config.json
@@ -152,27 +152,7 @@
                        },
                        {
                                &quot;type&quot;: &quot;uts&quot;
-                       },
-                       {
-                               &quot;type&quot;: &quot;mount&quot;
                        }
-               ],
-               &quot;maskedPaths&quot;: [
-                       &quot;/proc/kcore&quot;,
-                       &quot;/proc/latency_stats&quot;,
-                       &quot;/proc/timer_list&quot;,
-                       &quot;/proc/timer_stats&quot;,
-                       &quot;/proc/sched_debug&quot;,
-                       &quot;/sys/firmware&quot;,
-                       &quot;/proc/scsi&quot;
-               ],
-               &quot;readonlyPaths&quot;: [
-                       &quot;/proc/asound&quot;,
-                       &quot;/proc/bus&quot;,
-                       &quot;/proc/fs&quot;,
-                       &quot;/proc/irq&quot;,
-                       &quot;/proc/sys&quot;,
-                       &quot;/proc/sysrq-trigger&quot;
                ]
        }
+}
</code></pre>
<p>If we re-do the exercise we did previously, you will find <em>no</em> new namespace will be created this time, but you can't list the files outside of the rootfs.</p>
<p>Throw some code here to make things more clear. Ignore NoPivotRoot at the moment and assume it is already false.</p>
<pre><code class="language-go">if config.NoPivotRoot {
        err = msMoveRoot(config.Rootfs)
} else if config.Namespaces.Contains(configs.NEWNS) {
    err = pivotRoot(config.Rootfs)
} else {
    err = chroot(config.Rootfs)
}
</code></pre>
<h2 id="bind-mount">Bind Mount</h2>
<p><code>bind mount</code> is a feature supported by Linux that allows a portion of the file hierarchy to be remounted elsewhere, making it accessible from both locations. This is often used to share a host directory with a container.</p>
<p>The following change to the <code>config.json</code> instructs the container runtime to bind mount a local directory (<code>host_dir</code>, a relative path to the runtime bundle) to a directory (<code>/host_dir</code>, an absolute path in the container's root file system).</p>
<pre><code>diff --git a/config.json b/config.json
index 25a3154..13ae9bf 100644
--- a/config.json
+++ b/config.json
@@ -129,6 +129,11 @@
                                &quot;relatime&quot;,
                                &quot;ro&quot;
                        ]
+               },
+               {
+                       &quot;destination&quot;: &quot;/host_dir&quot;,
+                       &quot;type&quot;: &quot;bind&quot;,
+                       &quot;source&quot;: &quot;host&quot;
+                       &quot;options&quot; : [&quot;bind&quot;]
</code></pre>
<p>For bind mount to work, the host directory must exist before mounting, but not the bind destination dir, which will be created by the container runtime if not exists. Here is (part) the directory tree:</p>
<pre><code>:~/container/runc$ tree -L 2
.
├── config.json
├── host_dir  &lt;- host dir will be bind mounted
│   └── hi
├── rootfs
│   ├── bin
│   ├── etc
│   ├── home
│   ├── host

</code></pre>
<p>Start the container with the new config.json, and we can see the content of <code>host_dir</code> through <code>/host</code> in the container.</p>
<pre><code>/ # ls /host/
hi
</code></pre>
<p>However, since the bind mount is happening in the mount namespace for the container, not on the host, you won't be able to see anything in the <code>rootfs/host</code>.</p>
<p>We can double check this by looking at the mount info inside of the container:</p>
<pre><code># inside of the container
# cat /proc/self/mountinfo | grep host_dir
212 166 8:2 /home/binchen/container/runc/host_dir /host rw,relatime - ext4 /dev/disk/by-uuid/22cb3888-325e-4283-a605-d2f60d11bb96 rw,errors=remount-ro,data=ordered
</code></pre>
<h2 id="exercise-access-host-usb">Exercise: Access Host USB</h2>
<p>Let's do more exercises on how to access a host USB disk. why? Because USB disk is a volume device, it aligns with our topic today regarding data or filesystem in a container! Besides, as we'll see later, bind mount can be used not only for mounting a host directory, but also a host device file, into the container.</p>
<p>Make the following changes to the default <code>config.json</code> and we'll explain it shortly.</p>
<pre><code>diff --git a/config.json b/config.json
index 25a3154..5e58226 100644
--- a/config.json
+++ b/config.json
@@ -3,8 +3,8 @@
        &quot;process&quot;: {
                &quot;terminal&quot;: true,
                &quot;user&quot;: {
-                       &quot;uid&quot;: 0,
-                       &quot;gid&quot;: 0                              (3)
+                       &quot;uid&quot;: 1000,
+                       &quot;gid&quot;: 1000
                },
                &quot;args&quot;: [
                        &quot;sh&quot;
@@ -129,6 +129,16 @@
                                &quot;relatime&quot;,
                                &quot;ro&quot;
                        ]
+               },{
+                       &quot;destination&quot;: &quot;/dev/usb&quot;,
+                       &quot;type&quot;: &quot;bind&quot;,                      (1)
+                       &quot;source&quot;: &quot;/dev/sdb1&quot;
+                       &quot;options&quot;: [&quot;bind&quot;]
+               },
+               {
+                       &quot;destination&quot;: &quot;/usb2&quot;,
+                       &quot;type&quot;: &quot;vfat&quot;,                      (2)
+                       &quot;source&quot;: &quot;/dev/sdb1&quot;,
+                       &quot;options&quot;: [&quot;rw&quot;]
                }
        ],
</code></pre>
<p>start the container with the new config and we will be able to read and write to the usb from the /usb2 directory inside of the container.</p>
<pre><code>/usb2 $ echo &quot;hello usb&quot; &gt; container
/usb2 $ cat container
hello usb
</code></pre>
<p>Explain the changes we made:</p>
<ul>
<li><code>(1)</code> bind mount the device node from the host (<code>/dev/sdb1</code>) to the container(<code>/dev/usb</code>).</li>
<li><code>(2)</code> mount the device(<code>/dev/usb</code>) to a directory inside of the container (<code>/usb2</code>)</li>
<li><code>(3)</code> set up the uid/guid the bash process to the same as the uid/guid of the usb2 directory. Without this change, we will hit permission issues. We'll have another article on the user and permission in container, for now, just set the uid:gid as we have done here.</li>
</ul>
<pre><code>#in container
# cd usb2
sh: cd: can't cd to usb2: Permission denied
</code></pre>
<h2 id="user-permission-change-after-mount">User Permission Change After Mount</h2>
<p>Before mount,</p>
<pre><code> File: ‘usb2’
  Size: 4096          Blocks: 8          IO Block: 4096   directory
Device: 802h/2050d    Inode: 25879017    Links: 2
Access: (0777/drwxrwxrwx)  Uid: ( 1000/ binchen)   Gid: ( 1000/ binchen)
Access: 2018-05-11 09:38:17.639411272 +1000
Modify: 2018-05-10 15:13:05.321299162 +1000
Change: 2018-05-10 15:15:29.541298098 +1000
 Birth: -
</code></pre>
<p>Mount it:</p>
<pre><code>sudo mount -t vfat /dev/sdb1 usb2
</code></pre>
<p>After it:</p>
<pre><code>$ stat usb2
  File: ‘usb2’
  Size: 8192          Blocks: 16         IO Block: 8192   directory
Device: 811h/2065d    Inode: 1           Links: 3
Access: (0700/drwx------)  Uid: ( 1000/ binchen)   Gid: ( 1000/ binchen)
Access: 1970-01-01 10:00:00.000000000 +1000
Modify: 1970-01-01 10:00:00.000000000 +1000
Change: 1970-01-01 10:00:00.000000000 +1000
 Birth: -
</code></pre>
<p>Notice the inode changes (from 25879017 to 1), so does the permissions (from 0777 to 0700).</p>
<p>So after the mount, usb2 becomes the root file system of the sdb1 device, so the inode becomes 1, which is the first inode in a partition, and the new permission is the permission of that file system, not the permission of the mounting point!</p>
<p>If you want to change the owner/permission after the device being mounted, you chown/chmod. Or, you can use the options for the mount. (But, it doesn't work for vfat as I tried.)</p>
<p>see also <code>mount</code>.</p>
<blockquote>
<p>The previous contents (if any)  and owner and mode of dir become invisible, and as long as this filesystem
remains mounted, the pathname dir refers to the root of the filesystem on the device.</p>
</blockquote>
<h2 id="docker-volume">Docker Volume</h2>
<p>Lastly, a few words on <a href="https://docs.docker.com/storage/volumes/">volume</a>, which is a Docker terminology and is not covered by the OCI runtime spec. Fundamentally, it is still a mount, whether it's a bind mount of a directory (as we did in the host_dir mounting case) or a mount of a volume device (as we did in the USB case). We can think of volume as a "managed mount service from Docker" with a handy CLI interface.</p>
<h2 id="summary">Summary</h2>
<p>We discussed how a container creates a new mount namespace and confines the processes inside the container's root file system. We also talked about how a container uses mount and bind mount to access and share the host device and directory. We skimmed over the concept of volume from Docker, which is fundamentally a "managed mount".</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../assets/inject-link.js"></script>
      
    
  </body>
</html>